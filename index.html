<!DOCTYPE html>
<html>
    <head>
        <title>Tiny Religion</title>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
        <meta name="charset" content="UTF-8">
        <meta name="viewport" content="initial-scale=1">
        <meta name="description" content="A simple game about making your god happy by doing stuff which mostly consists of making babies and build bridges. This is a rewrite of the game that was made for the Ludum Dare 23.">
        <link rel="author" href="https://dagothig.com" />
        <link rel="canonical" href="https//tiny-religion.dagothig.com" />

                <!-- for Facebook -->
        <meta property="og:title" content="Tiny Religion" />
        <meta property="og:type" content="game" />
        <meta property="og:image" content="tiny-religion.dagothig.com/images/TitleScreen.png" />
        <meta property="og:url" content="tiny-religion.dagothig.com" />
        <meta property="og:description" content="A simple game about making your god happy by doing stuff which mostly consists of making babies and build bridges. This is a rewrite of the game that was made for the Ludum Dare 23." />

        <!-- for Twitter -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:title" content="Tiny Religion" />
        <meta name="twitter:description" content="A simple game about making your god happy by doing stuff which mostly consists of making babies and build bridges. This is a rewrite of the game that was made for the Ludum Dare 23." />
        <meta name="twitter:image" content="tiny-religion.dagothig.com/images/TitleScreen.png" />

        <link rel="stylesheet" type="text/css" href="style.css" />
        <script src="client/extensions.js"></script>
        <script src="client/pixi.min.js"></script>
        <script src="client/pixi-extensions.js"></script>

        <script src="client/sound.js"></script>
        <!-- Doesn't work on a lot of navigators -->
        <!--script src="client/music.js"></script>
        <script src="client/sheet1.js"></script>
        <script src="client/sheet2.js"></script-->

        <script src="client/sfx.js"></script>
        <script src="client/god.js"></script>
        <script src="client/kingdom.js"></script>
        <script src="client/island.js"></script>
        <script src="client/building.js"></script>
        <script src="client/person.js"></script>
        <script src="client/game.js"></script>

        <script src="client/ui.js"></script>
    </head>
    <body>
        <audio id="music1" loop src="sounds/Music1.mp3"></audio>
        <audio id="music2" loop src="sounds/Music2.mp3"></audio>
        <div id="container"></div>
        <script>
            music1.volume = music2.volume = 0.5;
            Music.switchTo(music1);

            PIXI.scaleModes.DEFAULT = PIXI.scaleModes.NEAREST;
            let renderer = PIXI.autoDetectRenderer(), scaling = 1;
            renderer.roundPixels = true;
            container.appendChild(renderer.view);
            let resize = () => {
                let w = container.clientWidth, h = container.clientHeight;
                scaling = 1;
                while (h < 320) {
                    w *= 2; h *= 2;
                    scaling++;
                }
                renderer.resize(w, h);
            }
            window.addEventListener('resize', resize);
            resize();

            let keys = [];
            window.isKeyPressed = key => !!keys[key];
            window.addEventListener('keydown', ev => keys[ev.keyCode] = true);
            window.addEventListener('keyup', ev => keys[ev.keyCode] = false);

            renderer.backgroundColor = 0xffffff;
            renderer.render(new PIXI.Container());
            let game, ui = new UI(g => game = g);
            ui.showTitle();
            PIXI.loader.load(() => {
                let last = performance.now();
                let upd = () => {
                    let time = performance.now();
                    let delta = time - last;
                    ui.update(delta, game);
                    if (game) {
                        game.update(delta, renderer.width, renderer.height);
                        renderer.backgroundColor = game.backgroundColor;
                        renderer.render(game);
                        game.checkForEnd();
                    }
                    last = time;
                    requestAnimationFrame(upd);
                }
                upd();
                resize();
            });

            let processTouchEvent = ev => {
                let newEv = Array.from(ev.touches).reduce((obj, touch) => {
                    obj.pageX += touch.pageX;
                    obj.pageY += touch.pageY;
                    return obj;
                }, { pageX: 0, pageY: 0 });
                newEv.pageX /= ev.touches.length;
                newEv.pageY /= ev.touches.length;
                newEv.pageX *= scaling;
                newEv.pageY *= scaling;
                return newEv;
            }
            let wrap = (f1, f2) => (...args) => f2(f1.apply(this, args));

            let mousedown = ev => game && game.beginDown(ev.pageX, ev.pageY);
            container.onmousedown = mousedown;
            container.ontouchstart = wrap(processTouchEvent, mousedown);

            let mousemove = ev => game && game.onMove(ev.pageX, ev.pageY);
            document.onmousemove = mousemove;
            document.ontouchmove = wrap(processTouchEvent, mousemove);

            document.ontouchend = document.onmouseup =
                ev => game && game.finishDown();
        </script>
    </body>
</html>