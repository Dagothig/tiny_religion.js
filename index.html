<!DOCTYPE html>
<html>
    <head>
        <title>Tiny Religion</title>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
        <meta name="charset" content="UTF-8">

        <link rel="stylesheet" type="text/css" href="style.css" />
        <script src="client/extensions.js"></script>
        <script src="client/pixi.min.js"></script>
        <script src="client/pixi-extensions.js"></script>

        <script src="client/sound.js"></script>
        <!-- Doesn't work on a lot of navigators -->
        <!--script src="client/music.js"></script>
        <script src="client/sheet1.js"></script>
        <script src="client/sheet2.js"></script-->

        <script src="client/sfx.js"></script>
        <script src="client/god.js"></script>
        <script src="client/kingdom.js"></script>
        <script src="client/island.js"></script>
        <script src="client/building.js"></script>
        <script src="client/person.js"></script>
        <script src="client/game.js"></script>

        <script src="client/ui.js"></script>
    </head>
    <body>
        <audio id="music1" loop src="sounds/Music1.mp3"></audio>
        <audio id="music2" loop src="sounds/Music2.mp3"></audio>
        <div id="container"></div>
        <script>
            music1.volume = music2.volume = 0.5;
            let music = music1;
            music.play();

            PIXI.scaleModes.DEFAULT = PIXI.scaleModes.NEAREST;
            let renderer = PIXI.autoDetectRenderer();
            renderer.roundPixels = true;
            container.appendChild(renderer.view);
            let resize = () => {
                let w = container.clientWidth, h = container.clientHeight;
                renderer.resize(w, h);
            }
            window.addEventListener('resize', resize);
            resize();

            let keys = [];
            window.isKeyPressed = key => !!keys[key];
            window.addEventListener('keydown', ev => keys[ev.keyCode] = true);
            window.addEventListener('keyup', ev => keys[ev.keyCode] = false);

            renderer.backgroundColor = 0xffffff;
            renderer.render(new PIXI.Container());
            let game, ui = new UI(g => game = g);
            ui.showTitle();
            PIXI.loader.load(() => {
                let last = performance.now();
                let upd = () => {
                    let time = performance.now();
                    let delta = time - last;
                    ui.update(delta, game);
                    if (game) game.update(delta, renderer.width, renderer.height);
                    // since update tick can finish the game, we have to check again
                    if (game) {
                        renderer.backgroundColor = game.backgroundColor;
                        renderer.render(game);
                    }
                    last = time;
                    requestAnimationFrame(upd);
                }
                upd();
                resize();
            });
            container.onmousedown = ev => game &&
                game.beginDown(ev.pageX, ev.pageY);
            document.onmouseup = ev => game &&
                game.finishDown(ev.pageX, ev.pageY);
            document.onmousemove = ev => game &&
                game.onMove(ev.pageX, ev.pageY);
        </script>
    </body>
</html>